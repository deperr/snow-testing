---
- name: Update ServiceNow incident using variables from AAP workflow
  hosts: localhost
  gather_facts: true
  
  module_defaults:
    servicenow.itsm.incident:
      instance:
        host: "{{ servicenow_instance }}"
        username: "{{ servicenow_username }}"
        password: "{{ servicenow_password }}"

  tasks:
    - name: Debug all available variables
      ansible.builtin.debug:
        msg:
          - "ðŸ” Debugging Available Variables:"
          - "================================="
          - "All variables from hostvars:"
          - "{{ hostvars[inventory_hostname] | dict2items | map(attribute='key') | list | sort }}"
          - ""
          - "Checking for expected workflow variables:"
          - "incident_sys_id: {{ incident_sys_id | default('UNDEFINED') }}"
          - "incident_number: {{ incident_number | default('UNDEFINED') }}"
          - "servicenow_instance: {{ servicenow_instance | default('UNDEFINED') }}"
          - "incident_created_timestamp: {{ incident_created_timestamp | default('UNDEFINED') }}"
          - "incident_initial_state: {{ incident_initial_state | default('UNDEFINED') }}"
          - "incident_url: {{ incident_url | default('UNDEFINED') }}"
      tags:
        - debug
        - validation

    - name: Validate workflow variables are available
      ansible.builtin.assert:
        that:
          - incident_sys_id is defined
          - incident_sys_id | length > 0
          - incident_number is defined
          - incident_number | length > 0
          - servicenow_instance is defined
        fail_msg: |
          Required variables from previous playbook are missing!
          
          Expected variables:
          - incident_sys_id: {{ incident_sys_id | default('UNDEFINED') }}
          - incident_number: {{ incident_number | default('UNDEFINED') }}
          - servicenow_instance: {{ servicenow_instance | default('UNDEFINED') }}
          
          These should be set by the previous playbook using set_stats.
          Check that:
          1. The creation playbook completed successfully
          2. The set_stats task executed without errors
          3. The AAP workflow is properly configured to pass artifacts between nodes
          4. No filters are blocking variable propagation in the workflow
        success_msg: |
          âœ… Required variables found:
          - incident_sys_id: {{ incident_sys_id }}
          - incident_number: {{ incident_number }}
          - servicenow_instance: {{ servicenow_instance }}

    - name: Display received workflow variables
      ansible.builtin.debug:
        msg:
          - "ðŸ“¨ Variables Received from AAP Workflow:"
          - "========================================"
          - "Incident Number: {{ incident_number }}"
          - "Incident Sys ID: {{ incident_sys_id }}"
          - "Initial State: {{ incident_initial_state | default('unknown') }}"
          - "Created: {{ incident_created_timestamp | default('unknown') }}"
          - "URL: {{ incident_url | default('not provided') }}"

    - name: Update incident with assignment and work notes
      servicenow.itsm.incident:
        sys_id: "{{ incident_sys_id }}"
        state: present
        assignment_group: "{{ incident_assignment_group | default('IT Support') }}"
        assigned_to: "{{ incident_assigned_to | default(omit) }}"
        work_notes: |
          Incident updated via AAP workflow on {{ ansible_date_time.iso8601 }}
          
          Original Incident: {{ incident_number }}
          Previous State: {{ incident_initial_state | default('unknown') }}
          New State: {{ incident_update_state | default('in_progress') }}
          
          Workflow Variables Used:
          - incident_sys_id: {{ incident_sys_id }}
          - incident_created_timestamp: {{ incident_created_timestamp | default('not provided') }}
        other:
          state: "{{ incident_update_state | default('in_progress') }}"
      register: updated_incident

    - name: Display incident update results
      ansible.builtin.debug:
        msg:
          - "âœ… ServiceNow Incident Updated Successfully!"
          - "============================================"
          - "Number: {{ incident_number }}"
          - "Sys ID: {{ incident_sys_id }}"
          - "Updated State: {{ updated_incident.record.state }}"
          - "Assignment Group: {{ updated_incident.record.assignment_group | default('Not assigned') }}"
          - "Assigned To: {{ updated_incident.record.assigned_to | default('Not assigned') }}"
          - "Last Updated: {{ updated_incident.record.sys_updated_on }}"
          - "URL: {{ incident_url | default('https://' + servicenow_instance + '/nav_to.do?uri=incident.do?sys_id=' + incident_sys_id) }}"

    - name: Export final incident state for potential next workflow steps
      delegate_to: localhost
      run_once: true
      ansible.builtin.set_stats:
        data:
          final_incident_state: "{{ updated_incident.record.state }}"
          final_assignment_group: "{{ updated_incident.record.assignment_group }}"
          final_assigned_to: "{{ updated_incident.record.assigned_to | default('Unassigned') }}"
          incident_last_updated: "{{ updated_incident.record.sys_updated_on }}"
          workflow_completed_timestamp: "{{ ansible_date_time.iso8601 }}"
