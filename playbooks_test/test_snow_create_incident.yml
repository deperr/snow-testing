---

- name: ServiceNow ITSM - Create Incidents
  hosts: localhost
  gather_facts: false
  
  module_defaults:
    servicenow.itsm.incident:
      instance:
        host: "{{ servicenow_instance }}"
        username: "{{ servicenow_username }}"
        password: "{{ servicenow_password }}"
    servicenow.itsm.incident_info:
      instance:
        host: "{{ servicenow_instance }}"
        username: "{{ servicenow_username }}"
        password: "{{ servicenow_password }}"
        # Optional OAuth configuration (uncomment if using OAuth)
        # client_id: "{{ servicenow_client_id | default(omit) }}"
        # client_secret: "{{ servicenow_client_secret | default(omit) }}"

  tasks:
    - name: Create incident ticket in ServiceNow
      register: created_incident
      when: create_incident | default(true) | bool
      tags:
        - create
        - incident
      servicenow.itsm.incident:
        short_description: "{{ incident_short_description | default('Incident created via AAP') }}"
        description: "{{ incident_description | default('This is an incident created using Ansible Automation Platform with servicenow.itsm collection') }}"
        urgency: "{{ incident_urgency | default('medium') }}"
        impact: "{{ incident_impact | default('medium') }}"
        caller: "{{ incident_caller | default(servicenow_username) }}"
        other:
          state: "{{ incident_stat | default('new') }}"

    - name: Display created incident details
      when: 
        - create_incident | default(true) | bool
        - created_incident is succeeded
        - created_incident.record is defined
      tags:
        - create
        - incident
      ansible.builtin.debug:
        msg: 
          - "âœ… Incident created successfully!"
          - "Number: {{ created_incident.record.number }}"
          - "Sys ID: {{ created_incident.record.sys_id }}"
          - "State: {{ created_incident.record.state }}"
          - "Priority: {{ created_incident.record.priority }}"
          - "Assigned to: {{ created_incident.record.assignment_group }}"
          - "URL: {{ servicenow_instance }}/nav_to.do?uri=incident.do?sys_id={{ created_incident.record.sys_id }}"

    - name: Debug - Check if incident was created successfully
      ansible.builtin.debug:
        msg:
          - "ğŸ” Checking incident creation status"
          - "created_incident defined: {{ created_incident is defined }}"
          - "created_incident succeeded: {{ created_incident is succeeded if created_incident is defined else 'N/A' }}"
          - "created_incident.record defined: {{ created_incident.record is defined if created_incident is defined else 'N/A' }}"
          - "sys_id available: {{ created_incident.record.sys_id is defined if (created_incident is defined and created_incident.record is defined) else 'N/A' }}"

    - name: Persist variables for AAP workflow (simple pattern like playbook_one)
      delegate_to: localhost
      run_once: true
      ansible.builtin.set_stats:
        data:
          incident_sys_id: "{{ created_incident.record.sys_id }}"
          incident_number: "{{ created_incident.record.number }}"
          incident_url: "{{ servicenow_instance }}/nav_to.do?uri=incident.do?sys_id={{ created_incident.record.sys_id }}"
          servicenow_instance: "{{ servicenow_instance }}"
          workflow_timestamp: "{{ ansible_date_time.iso8601 }}"
      when:
        - created_incident is defined
        - created_incident is succeeded
        - created_incident.record is defined

    - name: Debug - Confirm variables were set for workflow
      ansible.builtin.debug:
        msg:
          - "âœ… Variables set for AAP workflow:"
          - "incident_sys_id: {{ created_incident.record.sys_id }}"
          - "incident_number: {{ created_incident.record.number }}"
          - "servicenow_instance: {{ servicenow_instance }}"
      when:
        - created_incident is defined
        - created_incident is succeeded
        - created_incident.record is defined

    - name: Display creation summary
      tags:
        - create
        - summary
      ansible.builtin.debug:
        msg: 
          - "ğŸ‰ ServiceNow Ticket Creation Summary"
          - "=====================================  "
          - "{% if created_problem is defined and created_problem is succeeded %}âœ… Problem: {{ created_problem.record.number }}{% endif %}"
          - "ğŸ• Created at: {{ ansible_date_time.iso8601 }}"
          - "ğŸ‘¤ Created by: {{ servicenow_username }}"