---

- name: ServiceNow ITSM - Create Incidents
  hosts: localhost
  gather_facts: false
  
  module_defaults:
    servicenow.itsm.incident:
      instance:
        host: "{{ servicenow_instance }}"
        username: "{{ servicenow_username }}"
        password: "{{ servicenow_password }}"
    servicenow.itsm.incident_info:
      instance:
        host: "{{ servicenow_instance }}"
        username: "{{ servicenow_username }}"
        password: "{{ servicenow_password }}"
        # Optional OAuth configuration (uncomment if using OAuth)
        # client_id: "{{ servicenow_client_id | default(omit) }}"
        # client_secret: "{{ servicenow_client_secret | default(omit) }}"

  tasks:
    - name: Create incident ticket in ServiceNow
      register: created_incident
      when: create_incident | default(true) | bool
      tags:
        - create
        - incident
      servicenow.itsm.incident:
        short_description: "{{ incident_short_description | default('Incident created via AAP') }}"
        description: "{{ incident_description | default('This is an incident created using Ansible Automation Platform with servicenow.itsm collection') }}"
        urgency: "{{ incident_urgency | default('medium') }}"
        impact: "{{ incident_impact | default('medium') }}"
        caller: "{{ incident_caller | default(servicenow_username) }}"
        other:
          state: "{{ incident_stat | default('new') }}"

    - name: Display created incident details
      when: 
        - create_incident | default(true) | bool
        - created_incident is succeeded
        - created_incident.record is defined
      tags:
        - create
        - incident
      ansible.builtin.debug:
        msg: 
          - "✅ Incident created successfully!"
          - "Number: {{ created_incident.record.number }}"
          - "Sys ID: {{ created_incident.record.sys_id }}"
          - "State: {{ created_incident.record.state }}"
          - "Priority: {{ created_incident.record.priority }}"
          - "Assigned to: {{ created_incident.record.assignment_group }}"
          - "URL: {{ servicenow_instance }}/nav_to.do?uri=incident.do?sys_id={{ created_incident.record.sys_id }}"

    - name: Set incident facts for workflow use
      ansible.builtin.set_fact:
        incident_number: "{{ created_incident.record.number }}"
        created_incident_sys_id: "{{ created_incident.record.sys_id }}"
        created_incident_state: "{{ created_incident.record.state }}"

    - name: Save incident details to job artifacts
      delegate_to: localhost
      run_once: true
      ansible.builtin.set_stats:
        data:
          incident_number: "{{ created_incident.record.number }}"
          incident_sys_id: "{{ created_incident.record.sys_id }}"
          incident_state: "{{ created_incident.record.state }}"
          incident_priority: "{{ created_incident.record.priority }}"
          incident_url: "{{ servicenow_instance }}/nav_to.do?uri=incident.do?sys_id={{ created_incident.record.sys_id }}"
        per_host: false
        aggregate: false

    - name: Display creation summary
      tags:
        - create
        - summary
      ansible.builtin.debug:
        msg: 
          - "🎉 ServiceNow Ticket Creation Summary"
          - "=====================================  "
          - "{% if created_problem is defined and created_problem is succeeded %}✅ Problem: {{ created_problem.record.number }}{% endif %}"
          - "🕐 Created at: {{ ansible_date_time.iso8601 }}"
          - "👤 Created by: {{ servicenow_username }}"

  handlers:
    - name: Send notification on ticket creation
      listen: "notify_ticket_created"
      ansible.builtin.debug:
        msg: "Notification: New ServiceNow tickets have been created and are ready for processing"